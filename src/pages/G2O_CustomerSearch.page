<apex:page standardController="Account"
    extensions="G2O_CustomerSearch_VFCx" tabstyle="Account">
    <script
        src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"
        type="text/javascript"></script>
    <apex:includeScript value="/support/console/26.0/integration.js" />
    <!-- @CR: Static resource this -->
    <script>
        lockEnter = false;
        function replaceEnter(e){
            e = e || window.event;
            if (e.keyCode==13) {
                if (!lockEnter)
                {
                    lockEnter = true; // prevents user submitting twice. Cleared after re-render.
                    var allElements = document.getElementsByTagName('input');
                    for (var i = 0; i < allElements.length; i++){
                        if (allElements[i].id.indexOf("customerExtSearchButton") !=-1){
                          allElements[i].click();
                          break;
                        }
                    }
                }
                return false;
            }
            return true;
        }
        document.onkeypress = replaceEnter;
        
        function showLoadingSpinner(wrapperClassName)
        {
            $('.'+wrapperClassName+' .paginationControls').hide();
            $('.'+wrapperClassName+' .loadingSpinner').show();
        }
        
        function hideLoadingSpinner(wrapperClassName)
        {
            $('.'+wrapperClassName+' .paginationControls').show();
            $('.'+wrapperClassName+' .loadingSpinner').hide();
        }
        
        function toggleNextRow()
        {
            $(this).closest('tr').next().toggle();
            $(this).closest('tr').find('img').first().toggleClass('showAccountWS')
            $(this).closest('tr').find('img').first().toggleClass("hideAccountWS");
        }
        
        var legalEntitySelected = '';
        function preventMultipleLESelection(theCheckbox, thisLegalEntitityId)
        {   
            if (!theCheckbox.checked)
            {
                //Check to see if all ws have been unchecked
                //If so, clean out the selected array
                clear = true;
                checkboxes = $(theCheckbox).closest('table').find('input:checkbox');
                for(var i=1; i<checkboxes.length; i++)
                {
                    if ($(checkboxes[i]).prop('checked'))
                    {
                        clear = false;
                    }
                }
                if (clear) legalEntitySelected='';
            } else {
                if (legalEntitySelected && legalEntitySelected!='' && legalEntitySelected!=thisLegalEntitityId)
                {
                    theCheckbox.checked = false;
                    alert("{!$Label.PAR_Multiple_LE_Error}");
                } else {
                    legalEntitySelected = thisLegalEntitityId;
                }
            }
        }
        
        function checkForConsole(url){
            if (url != null){
                if(sforce.console.isInConsole()){
                    sforce.console.openPrimaryTab(null, url, true);
                }
                else{
                    window.open(url);                
                }
            }
        } 
    </script>

    <style type="text/css">
img.showAccountWS {
    background: transparent url('/img/alohaSkin/twisty_sprite.png') 0 0
        no-repeat;
}

img.hideAccountWS {
    background: transparent url('/img/alohaSkin/twisty_sprite.png') 0 -11px
        no-repeat;
}

.paginationControls,.loadingSpinner {
    margin-top: 4px;
}

.loadingSpinner {
    line-height: 24px;
    padding-left: 24px;
    display: block;
    background: url(/img/loading24.gif) no-repeat;
}
</style>

    <apex:form >
        <!-- START: Headings -->
        <apex:outputPanel id="headers">
            <!-- Case : Account Validation -->
            <apex:sectionheader title="{!$Label.Ext_External_Provider_Validation}"
                subtitle="{!$Label.Customer_Search}" rendered="{!isExistingAccount}" />

            <!-- Case : Account Create -->
            <apex:sectionheader title="{!$Label.Customer_Search_Create}"
                subtitle="{!$Label.Customer_Search}"
                rendered="{!!isExistingAccount}" />

            <!--  Page Messages -->
            <apex:pageMessages />

        </apex:outputPanel>
        <!-- END: Headings -->

        <!-- START: Main panel -->
        <apex:outputPanel id="mainWrapper">
            <script>var lockEnter=false;// Locks the ENTER script from firing again while loading</script>

            <!-- START : Enter Detail Section -->
            <apex:pageBlock title="{!$Label.Enter_Details}"
                rendered="{!!customersCreated}">
                <apex:pageBlockButtons >
                    <apex:commandButton id="customerExtSearchButton"
                        value="{!$Label.Search}" action="{!doSearch}"
                        rerender="loadingSpinnerExternal, mainWrapper, headers"
                        status="loadingSpinnerExternal" />
                    <apex:commandButton value="{!$Label.Cancel_Search}"
                        action="{!cancel}" />
                </apex:pageBlockButtons>
                <apex:pageBlockSection columns="1">
                    <apex:repeat value="{!$ObjectType.Account.FieldSets.CustomerSearch}" var="f">
                        <!-- Show search fields from field set. Display conditions: Show an alternative label for 'Visiting' address fields, force some fields to be output (read only) when creating a child account -->
                        <apex:inputField value="{!theAccount[f.fieldPath]}"
                            required="{!f.required}"
                            label="{!IF(CONTAINS(f.fieldPath,'Postal'),$Label['alt_'+SUBSTITUTE(f.fieldPath,'__c','')], f.label)}"
                            rendered="{!!(isNewChildAccount && (f.fieldPath=='Corporate_Registration_Number__c' || f.fieldPath=='External_Provider_Party_ID__c' || f.fieldPath=='VAT_Number__c'))}">
                        </apex:inputField>
                        <apex:outputField value="{!theAccount[f.fieldPath]}"
                            rendered="{!isNewChildAccount && (f.fieldPath=='Corporate_Registration_Number__c' || f.fieldPath=='External_Provider_Party_ID__c' || f.fieldPath=='VAT_Number__c')}">
                        </apex:outputField>
                    </apex:repeat>
                </apex:pageBlockSection>
            </apex:pageBlock>
            <!-- END : Enter Detail Section -->

            <!-- START: Search Results -->
            <apex:pageBlock id="searchResults"
                title="{!$Label.Result_for_Customer_Search_Title}"
                rendered="{!searched && !customersCreated}">

                <apex:pageBlockButtons >
                    <!-- Create selected button -->
                    <apex:commandButton value="{!$Label.Create_Selected}"
                        action="{!createSelected}"
                        rerender="mainWrapper, createdCustomerHierachy, alertMessage, headers"
                        status="loadingSpinnerExternalContact" />

                    <!-- Create unverified button - two different buttons shown depending on country and record type -->
                    <apex:commandButton value="{!$Label.Create_Unverified}"
                        rerender="loadingSpinner" action="{!createUnverified}"
                        status="loadingSpinner"
                        rendered="{!theAccount.Visiting_Address_Country__c!='DK' && theAccount.Postal_Address_Country__c!='DK' || !isWorksite}" />
                    <apex:commandButton value="{!$Label.Search_MOD}"
                        rerender="loadingSpinner" action="{!continueUnverifiedToMOD}"
                        status="loadingSpinner"
                        rendered="{!(theAccount.Visiting_Address_Country__c=='DK' || theAccount.Postal_Address_Country__c=='DK') && isWorksite}" />
                </apex:pageBlockButtons>

                <script>
                    // Reset the variable that tracks the current LE selected to allow javascript to prevent multiple LE selections
                    var legalEntitySelected = '';
                </script>

                <!-- START: Advice message on search : No results -->
                <apex:outputPanel rendered="{!searchResults.size<1}">
                    <apex:panelGrid columns="2">
                        <apex:image value="/img/msg_icons/confirm32.png" width="32"
                            height="32"></apex:image>
                        <apex:outputLabel value="{!$Label.Ext_No_Results_Found}"
                            style="line-height:32px; font-weight: bold" />
                    </apex:panelGrid>
                </apex:outputPanel>
                <!-- END: Advice message -->

                <!-- START: Advice message on external search fail -->
                <apex:outputPanel rendered="{!externalServiceFailure}">
                    <apex:panelGrid columns="2">
                        <apex:image value="/img/msg_icons/error32.png" width="32"
                            height="32"></apex:image>
                        <apex:outputLabel value="{!externalServiceFailure_Msg}"
                            style="line-height:32px; font-weight: bold" />
                    </apex:panelGrid>
                </apex:outputPanel>
                <!-- END: Advice message -->

                <apex:outputPanel id="searchResultsTable"
                    styleClass="searchResultsTable" layout="inline"
                    rendered="{!searchResults.size>0}">

                    <!-- \Paginated table -->
                    <apex:outputPanel >
                        <table width="100%" class="list" cellpadding="0" cellspacing="0">
                            <tr class="headerRow">
                                <td width="7%">Source</td>
                                <td width="19%">{!$Label.Account_Name}</td>
                                <td width="19%">{!$Label.Account_PopularName}</td>
                                <td width="19%">{!$Label.Corporate_Registration_Number}</td>
                                <td width="10%">{!$Label.Record_Name}</td>
                                <td width="7%">{!$Label.Verified}</td>
                                <td width="10%">{!$Label.Work_Site_Type}</td>
                                <td width="18%">{!$Label.Address}</td>
                                <td width="12%">{!$Label.External_Status}</td>
                            </tr>
                            <apex:repeat value="{!searchResults}" var="result">
                                <tr class="dataRow">
                                    <td width="7%" class="dataCell"><apex:outputLabel value="{!IF(result.isSFDC, $Label.SFDC, $Label.PAR)}" /></td>
                                    <td width="20%" class="dataCell"><apex:outputPanel rendered="{!result.hasChildren}">
                                            <img src="/s.gif"
                                                class="{!IF(result.childSelected, 'hideAccountWS','showAccountWS')}"
                                                border="0" height="11px" width="11px"
                                                style="padding-right: 4px;" />
                                        </apex:outputPanel> <apex:outputPanel rendered="{!!result.isSFDC}"
                                            styleClass="{!IF(result.hasChildren,'showAccountWS','')}">
                                            <apex:outputField value="{!result.theAccount.Name}" />
                                        </apex:outputPanel> <apex:outputPanel rendered="{!result.isSFDC}">
                                            <apex:outputLink value="#"
                                                onclick="checkForConsole('/{!result.theAccount.Id}');"
                                                rendered="{!result.isSFDC}">{!result.theAccount.Name}</apex:outputLink>
                                        </apex:outputPanel></td>
                                    <td width="20%" class="dataCell"><apex:outputField value="{!result.theAccount.Work_Site_Name__c}" /></td>
                                    <td width="20%" class="dataCell"><apex:outputField value="{!result.theAccount.Corporate_Registration_Number__c}" /></td>
                                    <td width="10%" class="dataCell"><apex:outputLabel value="{!IF(NOT(ISBLANK(result.theAccount.RecordType.Name)), result.theAccount.RecordType.Name, $Label.RecordType_Account_LE)}" /></td>
                                    <td width="7%" class="dataCell"><apex:outputField value="{!result.theAccount.Verified__c}" /></td>
                                    <td width="7%" class="dataCell"><apex:outputField value="{!result.theAccount.Work_Site_Type__c}" /></td>
                                    <td width="20%" class="dataCell"><apex:outputLabel value="{!result.address}" /></td>
                                    <td width="7%" class="dataCell"><apex:outputField value="{!result.theAccount.External_Legal_Entity_Status__c}" /></td>
                                </tr>
                                <tr class="dataRow" style="">
                                    <td colspan="100" style="padding: 10px; padding-left: 45px;">
                                        <h3>{!$Label.Customers_WorkSite_Heading}</h3> <br /> <apex:outputPanel layout="none">
                                            <table class="list" border="0" cellpadding="0"
                                                cellspacing="0">
                                                <tbody>
                                                    <apex:repeat id="repeatAccountworkSite"
                                                        value="{!result.childWorksites}" var="workSite">
                                                        <tr class="dataRow">
                                                            <td width="2%" class="dataCell"><apex:outputLabel value="{!IF(workSite.isSFDC, $Label.SFDC, $Label.PAR)}" />
                                                            </td>
                                                            <td width="2%" class="actionColumn"><apex:inputCheckbox id="selectAccountworkSite"
                                                                    onclick="preventMultipleLESelection(this, '{!workSite.parent.theAccount.External_Provider_Party_ID__c}')"
                                                                    value="{!workSite.selected}"
                                                                    disabled="{!workSite.isSFDC}" /></td>
                                                            <td width="20%" class="dataCell"><apex:outputLink value="#"
                                                                    onclick="checkForConsole('/{!workSite.theAccount.Id}');"
                                                                    rendered="{!workSite.isSFDC}">{!workSite.theAccount.Name}</apex:outputLink>
                                                                <apex:outputLabel value="{!workSite.theAccount.Name}"
                                                                    rendered="{!!workSite.isSFDC}" /></td>
                                                            <td width="20%" class="dataCell" align="left"><apex:outputField value="{!workSite.theAccount.Work_Site_Name__c}" /></td>
                                                            <td width="20%" class="dataCell" align="left"><apex:outputField value="{!workSite.theAccount.Corporate_Registration_Number__c}" /></td>
                                                            <td width="15%" class="dataCell"><apex:outputLabel value="{!$Label.RecordType_Account_WS}" /></td>
                                                            <td width="7%" class="dataCell"><apex:outputField value="{!workSite.theAccount.Verified__c}" /></td>
                                                            <td width="7%" class="dataCell"><apex:outputField value="{!workSite.theAccount.Work_Site_Type__c}" /></td>
                                                            <td width="20%" class="dataCell"><apex:outputLabel value="{!workSite.address}" /></td>
                                                            <td width="7%" class="dataCell"><apex:outputField value="{!workSite.theAccount.External_Work_Site_Status__c}" /></td>
                                                        </tr>
                                                    </apex:repeat>
                                                </tbody>
                                            </table>
                                        </apex:outputPanel>
                                    </td>
                                </tr>
                            </apex:repeat>
                        </table>
                        <script>
                        $(".showAccountWS").click(toggleNextRow);
                        $(".hideAccountWS").click(toggleNextRow);
                    </script>
                    </apex:outputPanel>

                    <!-- /Paginated table -->
                    <!-- \Pagination controls -->
                    <apex:outputPanel styleClass="paginationControls">
                        <apex:commandButton action="{!searchResultsPagination.first}"
                            disabled="{!!searchResultsPagination.showPreviousButton}"
                            rerender="searchResultsTable" status="search_loadingSpinner"
                            value="|<<" />
                        <apex:commandButton action="{!searchResultsPagination.previous}"
                            disabled="{!!searchResultsPagination.showPreviousButton}"
                            rerender="searchResultsTable" status="search_loadingSpinner"
                            value="<<" />
                        <span style="padding: 0 1em;">{!$Label.Page}
                            {!searchResultsPagination.pageNumber} -
                            {!searchResultsPagination.numberOfPages}</span>
                        <apex:commandButton action="{!searchResultsPagination.next}"
                            disabled="{!!searchResultsPagination.showNextButton}"
                            rerender="searchResultsTable" status="search_loadingSpinner"
                            value=">>" />
                        <apex:commandButton action="{!searchResultsPagination.last}"
                            disabled="{!!searchResultsPagination.showNextButton}"
                            rerender="searchResultsTable" status="search_loadingSpinner"
                            value=">>|" />
                    </apex:outputPanel>
                    <!-- /Pagination controls -->

                    <!-- \Pagination Loading Spinner -->
                    <div class="loadingSpinner" style="display: none;">
                        <span class="waitingDescription">{!$Label.Loading}</span>
                    </div>
                    <!-- /Pagination Loading Spinner -->

                </apex:outputPanel>
                <apex:actionstatus id="search_loadingSpinner"
                    onstart="showLoadingSpinner('searchResultsTable');"
                    onstop="hideLoadingSpinner('searchResultsTable');" />
            </apex:pageBlock>
            <!-- END: Search Results -->

            <!-- START: Show Customer Created -->
            <apex:pageBlock id="createdCustomerHierachy"
                title="{!$Label.Customer_Created_Hierarchy_Title}"
                rendered="{!customersCreated}">
                <apex:outputPanel >
                    <table width="100%" class="list" cellpadding="0" cellspacing="0">
                        <tr class="headerRow">
                            <td width="19%">{!$Label.Account_Name}</td>
                            <td width="19%">{!$Label.Account_PopularName}</td>
                            <td width="19%">{!$Label.Corporate_Registration_Number}</td>
                            <td width="10%">{!$Label.Record_Name}</td>
                            <td width="7%">{!$Label.Verified}</td>
                            <td width="10%">{!$Label.Work_Site_Type}</td>
                            <td width="18%">{!$Label.Address}</td>
                            <td width="12%">{!$Label.External_Status}</td>
                        </tr>
                        <tr class="dataRow">
                            <td width="20%" class="dataCell"><apex:outputLink id="linkShowHide" value="#"
                                    onclick="checkForConsole('/{!selectedLegalEntity.theAccount.Id}');">{!selectedLegalEntity.theAccount.Name}</apex:outputLink>
                            </td>
                            <td width="20%" class="dataCell"><apex:outputField value="{!selectedLegalEntity.theAccount.Work_Site_Name__c}" /></td>
                            <td width="20%" class="dataCell"><apex:outputField value="{!selectedLegalEntity.theAccount.Corporate_Registration_Number__c}" /></td>
                            <td width="10%" class="dataCell"><apex:outputLabel value="{!$Label.RecordType_Account_LE}" /></td>
                            <td width="7%" class="dataCell"><apex:outputField value="{!selectedLegalEntity.theAccount.Verified__c}" /></td>
                            <td width="7%" class="dataCell"><apex:outputField value="{!selectedLegalEntity.theAccount.Work_Site_Type__c}" /></td>
                            <td width="20%" class="dataCell"><apex:outputLabel value="{!selectedLegalEntity.address}" /></td>
                            <td width="7%" class="dataCell"><apex:outputField value="{!selectedLegalEntity.theAccount.External_Legal_Entity_Status__c}" /></td>
                        </tr>
                        <tr class="dataRow">
                            <td colspan="100" style="padding: 10px; padding-left: 45px;">
                                <h3>{!$Label.Customers_WorkSite_Heading}</h3> <br />
                                <table id="tableCustWS" class="list" border="0" cellpadding="0"
                                    cellspacing="0">
                                    <tbody>
                                        <apex:repeat value="{!selectedLegalEntity.childWorksites}"
                                            var="newWorksite">
                                            <tr class="dataRow">
                                                <td width="20%" class="dataCell"><apex:outputLink value="#"
                                                        onclick="checkForConsole('/{!newWorksite.theAccount.id}');">{!newWorksite.theAccount.Name}</apex:outputLink>
                                                </td>
                                                <td width="20%" class="dataCell" align="left"><apex:outputField value="{!newWorksite.theAccount.Work_Site_Name__c}" /></td>
                                                <td width="20%" class="dataCell" align="left"><apex:outputField value="{!newWorksite.theAccount.Corporate_Registration_Number__c}" /></td>
                                                <td width="15%" class="dataCell" align="left"><apex:outputLabel value="{!newWorksite.RTName}" /></td>
                                                <td width="7%" class="dataCell" align="left"><apex:outputField value="{!newWorksite.theAccount.Verified__c}" /></td>
                                                <td width="7%" class="dataCell" align="left"><apex:outputField value="{!newWorksite.theAccount.Work_Site_Type__c}" /></td>
                                                <td width="20%" class="dataCell" align="left"><apex:outputLabel value="{!newWorksite.address}" /></td>
                                                <td width="7%" class="dataCell" align="left"><apex:outputField value="{!newWorksite.theAccount.External_Work_Site_Status__c}" /></td>
                                            </tr>
                                        </apex:repeat>
                                    </tbody>
                                </table>
                            </td>
                        </tr>
                    </table>
                </apex:outputPanel>
            </apex:pageBlock>
            <!-- END: Show Customer Created -->

            <!-- START: show error alert -->
            <apex:outputPanel id="alertMessage">
                <script>
                    lockEnter = false;
                    var alertMessage = "{!alertMessage}";
                    if(alertMessage && alertMessage != ''){
                        alert(alertMessage);
                    }
                </script>
            </apex:outputPanel>
            <!-- END: show error alert -->
        </apex:outputPanel>
        <!-- END: Main panel -->

        <!-- START : General loading spinner that covers the whole page -->
        <apex:actionstatus id="loadingSpinner">
            <apex:facet name="start">
                <div class="waitingSearchDiv" id="el_loading"
                    style="background: url({!$Resource.TransparentBackground_FFFFFF_50pc}) transparent; height: 100%; width: 100%;">
                    <div class="waitingHolder">
                        <img class="waitingImage" src="/img/loading32.gif" title="*" /> <span
                            class="waitingDescription">{!$Label.Loading}</span>
                    </div>
                </div>
            </apex:facet>
        </apex:actionstatus>

        <apex:actionstatus id="loadingSpinnerExternal">
            <apex:facet name="start">
                <div class="waitingSearchDiv" id="el_loading"
                    style="background: url({!$Resource.TransparentBackground_FFFFFF_50pc}) transparent; height: 100%; width: 100%;">
                    <div class="waitingHolder">
                        <img class="waitingImage" src="/img/loading32.gif" title="*" /> <span
                            class="waitingDescription">{!$Label.Searching_External_Provider}</span>
                    </div>
                </div>
            </apex:facet>
        </apex:actionstatus>

        <apex:actionstatus id="loadingSpinnerExternalContact">
            <apex:facet name="start">
                <div class="waitingSearchDiv" id="el_loading"
                    style="background: url({!$Resource.TransparentBackground_FFFFFF_50pc}) transparent; height: 100%; width: 100%;">
                    <div class="waitingHolder">
                        <img class="waitingImage" src="/img/loading32.gif" title="*" /> <span
                            class="waitingDescription">{!$Label.Searching_External_Provider_Contacts}</span>
                    </div>
                </div>
            </apex:facet>
        </apex:actionstatus>
        <!-- END : General loading spinner -->

        <!-- Hidden output fields to avoid 'AddFields' being used on the controller -->
        <apex:outputPanel style="display:none;">
            <apex:outputField value="{!Account.Registration_Country__c}" />
        </apex:outputPanel>
    </apex:form>
</apex:page>